name: CI

# Trigger workflow on push to main branch
on:
  push:
    branches: [ main ]

jobs:
  # Job: Run code checks, linters, and tests
  ci-code:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Set up Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 24

      # Install project dependencies
      - name: Install dependencies
        run: npm ci

      # Run linters and static analysis (SAST)
      - name: Run linters + SAST
        run: npm run check

      # Run unit tests using Vitest
      - name: Run unit tests with Vitest
        run: npm run test
          
  # Job: Build and scan Docker image
  ci-image:
    runs-on: ubuntu-latest
    needs: ci-code  # Depends on ci-code passing
    permissions:
      contents: read
      packages: write
    outputs:
      image_sha: ${{ steps.image_sha.outputs.image_sha }}
    steps:
      # Checkout repository again
      - name: Checkout repository
        uses: actions/checkout@v3

      # Authenticate to GitHub Container Registry (GHCR)
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      # Set up Docker Buildx for multi-platform builds
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build Docker image locally (no push yet)
      - name: Build Docker image locally
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true 
          tags: ghcr.io/${{ github.actor }}/snake:${{ github.sha }}
          platforms: linux/amd64

      # Set output variable for downstream jobs
      - name: Set output
        id: image_sha
        run: echo "image_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      # Scan Docker image for vulnerabilities with Trivy
      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ghcr.io/${{ github.actor }}/snake:${{ github.sha }}
          severity: CRITICAL
          exit-code: 1

      # Push Docker image to GHCR if scan passes
      - name: Push Docker image (scan OK)
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.actor }}/snake:${{ github.sha }}
          load: false

  # Job: Update GitOps repo with new image version
  ci-update:
    runs-on: ubuntu-latest
    needs: ci-image  # Depends on Docker image build
    permissions:
      contents: write
    steps:
      # Install yq and git (in case)
      - name: Install yq & git
        run: sudo apt-get update && sudo apt-get install -y yq git

      # Clone the GitOps repository
      - name: Clone GitOps repo
        run: git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.actor }}/k8s-gitops-platform.git

      # Update Helm values.yaml with new Docker image SHA
      - name: Update values.yaml
        run: |
          yq -i -y ".image.ver = \"${{ needs.ci-image.outputs.image_sha }}\"" k8s-gitops-platform/helm/values.yaml

      # Commit and push changes back to main branch
      - name: Commit & Push changes
        run: |
          cd k8s-gitops-platform
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add helm/values.yaml
          git commit -m "CI Automated Update: update image.ver to ${{ needs.ci-image.outputs.image_sha }}"
          git push origin main
